{% extends "base.html" %}
{% block title %}检测结果查看{% endblock %}
{% block welcome %}{{ user }}{% endblock %}
{% block name %}{{ user }}{% endblock %}
{% load iptags %}
{% load mytags %}
{% block menu %}
    <ul class="sidebar-nav noprint">
					<li class="sidebar-nav-link">
						<a href="{% url "index" %}">
							<i class="am-icon-home sidebar-nav-link-logo"></i> 首页
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url 'result_dis' %}" class="active">
							<i class="am-icon-clone sidebar-nav-link-logo"></i> 检测结果查看
							<span class="am-badge am-badge-secondary sidebar-nav-link-logo-ico am-round am-fr am-margin-right-sm"></span>
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url "source_set" %}">
							<i class="am-icon-table sidebar-nav-link-logo"></i> 检测来源设置
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url "testrule" %}">
							<i class="am-icon-calendar sidebar-nav-link-logo"></i> 检测规则设置
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url "speed" %}" >
							<i class="am-icon-calendar sidebar-nav-link-logo"></i> 检测起始点设置
						</a>
					</li>
                    <li class="sidebar-nav-heading"></li>
                    <li class="sidebar-nav-link">
                    </li>
			</div>
        </ul>
{% endblock %}
            {% block content %}
			<!-- 内容区域 -->

			<div class="tpl-content-wrapper">

				<div class="container-fluid am-cf">
					<div class="row noprint">
                        <div class="am-fl tpl-header-search" style="margin-right: 200px;">
                            <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " style="margin-left: 1150px"><a href="{% url "result_dis" %}?catas=allbaddata" style="color: white;">显示已检出结果</a></button>
                            <span><input class="am-btn am-btn-primary tpl-btn-bg-color-success " type=button name='button_export' title='打印1' onclick=preview(1); value="打印当前页内容"></span>
                        </div>
				</div>

                 <div class="row  am-cf">
                    <div class="am-u-sm-12 am-u-md-12 am-u-lg-12 widget-margin-bottom-lg">
							<div class="widget am-cf widget-body-lg">

								<div class="widget-body  am-fr">
									<div class="am-scrollable-horizontal ">
                                    <!--startprint1-->
										<table width="100%" class="am-table am-table-compact am-text-nowrap tpl-table-black" id="report" >
											<thead>
												<tr>
													<th>检测时间</th>
                                                    <th>检测域名</th>
                                                    <th>来源IP</th>
                                                    <th>来源地址</th>
                                                    <th>URL</th>
													<th>检测结果</th>
                                                     <th>匹配条件</th>
												</tr>
											</thead>
											<tbody>
                                            {% for re in users.object_list %}
                                                {% if re.is_target %}
                                                <tr class="gradeX" style="width:200px; height:50px;">
													<td>{{ re.created_at }} </td>
                                                    <td id="host" style="color: yellow;">{{ re.host }} <p style="display: none" class="hostid">{{ re.id }}</p><p style="display: none" class="catas">{{ cata }}</p></td>
                                                    {% if re.sloc != '' and re.sloc != None %}
                                                    <td>{{ re.sip | truncate_ip  }}
                                                        <div style="width: 50px;display:inline-block;">
                                                            <img class="imgage" style="width: 100%; height: 20px" src="data:image/jpeg;base64, {{ re.sloc | changepage }}" />
                                                        </div>
                                                    </td>
                                                    {% elif re.sloc == '' or re.sloc == None and re.sip != '' and re.sip != None%}
                                                <td id="image">{{ re.sip | truncate_ip }}
                                                        <div style="width: 50px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%;height: 20px" src="data:image/jpeg;base64, {{ re.sip | truncate_ip | ip2loc | changepage }}">
                                                        </div>
                                                </td>
                                                {% else %}
                                                    <td>None</td>
                                                {% endif %}
                                                    <td>{{ re.sloc }}</td>
                                                    {% if re.origin_url != '' %}
                                                        {% if re.origin_url|length <= 50 %}
                                                            <td>{{ re.origin_url }}</td>
                                                            {% else %}
                                                            <td>{{ re.origin_url | slice:'50'  }}...</td>
                                                            {% endif %}
                                                        {% else %}
                                                        <td>None</td>
                                                        {% endif %}
													<td><span style="color:yellow">已检出</span></td>
                                                {% if re.testdomain.ruletype == 'webshell'  %}
                                                    <td>{{ re.testdomain.content }}<a class="am-badge am-badge-warning am-round">webshell</a> </td>
                                                    {% else %}
                                                    <td>{{ re.testdomain.content }}<a class="am-badge am-badge-danger am-round">domain</a> </td>
                                                    {% endif %}
                                                <p id="con" style="display: none">{{ re.request_header }}</p>
												</tr>
                                                    <tr class="child_row_01" style="display: none"><td>记录时间:<br>{{ re.pattition_time }}<br></td><td colspan="4"><pre class="content">请求或COOKIE:<br/>{{ re.request_header }}</pre></td><td><button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " onclick="gethea()">打开网页</button>
                                                    </td><td><p id="keyword" style="display: none">{{ re.testdomain.content }}</p></td><td><p style="display: none" class="hosts" >{{ re.host }}</p><td></tr>
                                            {% else %}
												<tr class="gradeX" style="width:200px; height:50px;" id="row_01">
													<td>{{ re.created_at }} </td>
                                                    <td id="host">{{ re.host }} <p style="display: none" class="hostid">{{ re.id }}</p><p style="display: none" class="catas">{{ cata }}</p></td>
                                                    {% if re.sloc != '' and re.sloc != None %}
                                                    <td>{{ re.sip | truncate_ip  }}
                                                        <div style="width: 50px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%; height: 20px" src="data:image/jpeg;base64, {{ re.sloc | changepage }}">
                                                        </div>
                                                    </td>
                                                    {% elif re.sloc == '' or re.sloc == None and re.sip != '' and re.sip != None%}
                                                <td id="image">{{ re.sip | truncate_ip }}
                                                        <div style="width: 30px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%;height: 20px" src="data:image/jpeg;base64, {{ re.sip | truncate_ip | ip2loc | changepage }}">
                                                        </div>
                                                </td>
                                                {% else %}
                                                    <td>None</td>
                                                {% endif %}
                                                <p id="con" style="display: none">{{ re.request_header }}</p>
                                                    <td>{{ re.sloc }}</td>
                                                    {% if re.origin_url != '' %}
                                                        {% if re.origin_url|length <= 50 %}
                                                            <td>{{ re.origin_url }}</td>
                                                            {% else %}
                                                            <td>{{ re.origin_url | slice:'50'  }}...</td>
                                                            {% endif %}
                                                        {% else %}
                                                        <td>None</td>
                                                        {% endif %}
													<td><span style="color:greenyellow">未检出</span></td>
                                                    <td></td>
												</tr>
                                                    <tr class="child_row_01" style="display: none"><td>记录时间:<br>{{ re.pattition_time }}<br></td><td colspan="4"><pre class="content">请求或COOKIE:<br>{{ re.request_header }}</pre></td><td><button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " onclick="gethea()">打开网页</button></td><td><p style="display: none" class="hosts">{{ re.host }}</p><td></tr>
                                            {% endif %}
                                            {% endfor %}
												<!-- more data -->
											</tbody>
										</table>
                                    <!--endprint1-->
                                    <div>
                                    <nav aria-label="Page navigation" style="float: left" class="noprint">
                                    <div>
                                        <ul class="pagination">
                                                {% if users.has_previous %}
                                                    <li>
                                                    <a class="type-vale" href="?q={{ query }}&page=1&type={{ type }}&sort={{ sort }}&catas={{ cata }}" aria-label="Previous"><span aria-hidden="true">首页</span></a>
                                                    </li>
                                                    <li>
                                                    <a class="type-vale" href="?q={{ query }}&page={{ users.previous_page_number }}&type={{ type }}&sort={{ sort }}&catas={{ cata }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
                                                    </li>
                                                {% endif %}

                                               {% for pg in users.paginator.pager_num_range %}
                                                {% if pg == users.number %}
                                                <li class="active"><a class="type-vale" href="?q={{ query }}&page={{ pg }}&type={{ type }}&sort={{ sort }}&catas={{ cata }}">{{ pg }}</a></li>
                                                {% else %}
                                                <li><a class="type-vale" href="?q={{ query }}&page={{ pg }}&type={{ type }}&sort={{ sort }}&catas={{ cata }}">{{ pg }}</a></li>
                                                {% endif %}
                                                {% endfor %}
                                                {% if users.has_next %}
                                                    <li>
                                                        <a class="type-vale" href="?q={{ query }}&page={{ users.next_page_number }}&type={{ type }}&sort={{ sort }}&catas={{ cata }}" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
                                                    <li>
                                                        <a class="type-vale" href="?q={{ query }}&page={{ users.paginator.num_pages }}&type={{ type }}&sort={{ sort }}&catas={{ cata }}" aria-label="Next"><span aria-hidden="true">尾页</span></a></li>
                                                {% endif %}
                                        {% if result > 10 %}
                                            <div style="float:left;margin-left: 10px">
                                            <form  action="{% url "search_action" cata %}" method="post">
                                                        {% csrf_token %}
                                                    <input  type="text"  placeholder="页数" name="stuff" style="height: 35px;width: 50px;color: black;margin-left: 20px">
                                                        <button type="submit" style="display: none"></button>
                                                <span style="font-size: 20px;">{{ users.number }} /{{ users.paginator.num_pages }}</span>
                                                    </form>
                                            </div>
                                            {% else %}
                                        {% endif %}
                                            <span style="font-size: 20px;margin-left: 20px">共<strong style="font-size: large;color: yellowgreen">{{ result }}</strong>条数据,每页显示12条</span>
                                            </ul>
                                         </div>
                                            </nav>
                                    </div>
                                    </div>
								</div>
							</div>

						</div>
					</div>
        {% endblock %}
{% block js %}
    $(function (){
    var aa = 0;
 $(".gradeX").click(function(){
 $(this).toggleClass("selected");
    var b = $(this).find('.hostid').html();
    var c = $(this).find('.catas').html();
    if (aa == 0 ) {
 $(this).siblings().not(".gradeX").not(":first-child").hide();
 $(this).next().show().next().show();
        aa = 1;
    changestatus(b);
    } else {
        $(this).next().hide();
        aa = 0;
        if (c == 'baddata') {
        location.reload();
        } else{}
    }
 });
})
    function changestatus(val) {
        $.ajax({
                url: '{% url "changestatus"  %}',
                type: 'POST',
                data: {hostid: val},
                success:function (callback) {
                    }
                })
    };
    changeurl();
    function changeurl(){
        $('.child_row_01').each(function () {
            edn = $(this).html();
        edn =  edn.replace('Accept-Language', '\nAccept-Language');
        edn =  edn.replace('Referer', '\nReferer');
        edn =  edn.replace('X-Requested-With', '\nX-Requested-With');
        edn =  edn.replace('Accept-Encoding', '\nAccept-Encoding');
        edn =  edn.replace('Host', '\nHost');
        edn =  edn.replace('Accept', '\nAccept');
        edn =  edn.replace('User-Agent', '\nUser-Agent');
        edn =  edn.replace('Pragma', '\nPragma');
        edn =  edn.replace('Cookie', '\nCookie');
        edn =  edn.replace('Origin', '\nOrigin');
        edn =  edn.replace('Content-Type', '\nContent-Type');
        edn =  edn.replace('Cache-Control', '\nCache-Control');
        edn =  edn.replace('X-Forwarded-For', '\nX-Forwarded-For');
        edn =  edn.replace('Connection', '\nConnection');
        edn =  edn.replace('Content-Length', '\nContent-Length');
        edn =  edn.replace('If-Modified-Since', '\nIf-Modified-Since');
        edn =  edn.replace('If-None-Match', '\nIf-None-Match');
        $(this).html(edn);
    })
    };
    changecolor();
    function changecolor () {
            var con = '';
            $('.child_row_01').each(function () {
                var a = $(this).find('#keyword').html();
                if (typeof(a) == 'string') {
                    con = $(this).html();
                    var b = '<strong style="color: #ff3928;font-size: 18px">' + a + '</strong>'
                    var reg=new RegExp(a,"g");
                    var newstr=con.replace(reg, b);
                    $(this).html(newstr);}
                else {};
                });
        }
    function gethea() {
        $(".child_row_01").click(function(){
        var hosts = $(this).find('.hosts').html();
        var cookies = $(this).find('.content').html();
            $.ajax({
                url: '{% url "getheader"  %}',
                type: 'POST',
                data: {cookie: cookies, host: hosts},
                success:function (callback) {
                    var callback_dict = $.parseJSON(callback);
                    document.write(callback_dict);
                    }
                })
                })
                };
{% endblock %}
{% block other %}
{% endblock %}


