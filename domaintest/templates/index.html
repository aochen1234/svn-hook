{% extends "base.html" %}
{% block title %}HTTP检测首页{% endblock %}
{% block welcome %}{{ user }}{% endblock %}
{% block name %}{{ user }}{% endblock %}
{% load mytags %}
{% load iptags %}
{% block menu %}
    <ul class="sidebar-nav noprint">

					<li class="sidebar-nav-link">
						<a href="{% url "index" %}" class="active">
							<i class="am-icon-home sidebar-nav-link-logo"></i> 首页
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url 'result_dis' %}?catas=result">
							<i class="am-icon-clone sidebar-nav-link-logo"></i> 检测结果查看
							<span class="am-badge am-badge-secondary sidebar-nav-link-logo-ico am-round am-fr am-margin-right-sm"></span>
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url "source_set" %}">
							<i class="am-icon-table sidebar-nav-link-logo"></i> 检测来源设置
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url "testrule" %}">
							<i class="am-icon-calendar sidebar-nav-link-logo"></i> 检测规则设置
						</a>
					</li>
					<li class="sidebar-nav-link">
						<a href="{% url "speed" %}" >
							<i class="am-icon-calendar sidebar-nav-link-logo"></i> 检测起始点设置
						</a>
					</li>
                    <li class="sidebar-nav-heading"></li>
                    <li class="sidebar-nav-link">
                    </li>
			</div>
        </ul>
{% endblock %}
            {% block content %}
			<!-- 内容区域 -->

			<div class="tpl-content-wrapper">

				<div class="container-fluid am-cf">
					<div class="row">
						<div class="am-u-sm-12 am-u-md-12 am-u-lg-9">
							<div class="page-header-heading"><span class="am-icon-home page-header-heading-icon"></span> 流量 <small>检测系统</small></div>
							<p class="page-header-description">目前只支持HTTP检测。</p>
						</div>
					</div>

				</div>

				<div class="row-content am-cf">
					<div class="row  am-cf">
						<div class="am-u-sm-12 am-u-md-12 am-u-lg-4">
							<div class="widget am-cf">
								<div style="margin-left: 10px;margin-top: 20px">
									<div class="widget-title am-fl">本月累计检测数据</div>

								</div>
								<div class="widget-body am-fr">
									<div class="am-fl">
										<div class="widget-fluctuation-period-text" style="font-size: 30px">
                                           <p id="messagecontain"></p>
										</div>
									</div>
									<div class="am-fr am-cf">
										<div class="widget-fluctuation-description-amount am-text-danger">
                                            <a href="{% url "result_dis" %}?catas=allbaddata" style="color: white;font-size: 30px;text-decoration: underline"><p id="messageconta"></p></a>
										</div>
										<div class="widget-fluctuation-description-text am-text-right">
											检测异常信息
										</div>
									</div>
								</div>
							</div>

						</div>
						<div class="am-u-sm-12 am-u-md-6 am-u-lg-4">
							<div class="widget widget-primary am-cf">
								<div class="widget-statistic-header">
									 待检测数据
								</div>
								<div class="widget-statistic-body">
									<div class="widget-statistic-value">
                                        <p id="messagecontainer"></p>
									</div>
									<div class="widget-statistic-description">
										预计 {{ wait_time }} 内检测完成
									</div>
									<span class="widget-statistic-icon am-icon-credit-card-alt"></span>
								</div>
							</div>
						</div>
						<div class="am-u-sm-12 am-u-md-6 am-u-lg-4">
							<div class="widget widget-purple am-cf">
								<div class="widget-statistic-header">
									等待查看的结果
								</div>
								<div class="widget-statistic-body">
									<div class="widget-statistic-value">
                                        <a href="{% url "result_dis" %}?catas=baddata" style="color: white;text-decoration: underline"><p id="messagecon"></p></a>
									</div>
									<div class="widget-statistic-description">
										最后一条时间 <strong>{{ bad_data_time }}</strong>
									</div>
									<span class="widget-statistic-icon am-icon-support"></span>
								</div>
							</div>
						</div>
					</div>
					<div class="row am-cf">
                                <div class="widget am-cf">
								<div style="margin-left: 10px;margin-top: 10px">
									<div class="widget-title am-fl">本月检测情况</div>
								</div>
                               	<div style="height:250px;font-size: 20px" id="main">
								</div>
                                </div>
					<div class="row am-cf">

						<div class="am-u-sm-12 am-u-md-12 am-u-lg-12 widget-margin-bottom-lg">

							<div class="widget am-cf widget-body-lg">

								<div class="widget-body  am-fr">
									<div class="am-scrollable-horizontal ">
										<table width="100%" class="am-table am-table-compact am-text-nowrap tpl-table-black ">
											<thead>
												<tr>
													<th>检测时间</th>
                                                    <th>检测域名</th>
                                                    <th>来源IP</th>
                                                    <th>来源地址</th>
                                                    <th>URL</th>
													<th>检测结果</th>
                                                     <th>匹配规则</th>
												</tr>
											</thead>
											<tbody>
                                            {% for re in result_list %}
                                                {% if re.is_target %}
                                                <tr class="gradeX" style="width:200px; height:50px;">
													<td>{{ re.created_at }} </td>
                                                    <td style="color: yellow">{{ re.host }} </td>
                                                     {% if re.sloc != '' and re.sloc != None %}
                                                    <td id="image">{{ re.sip | truncate_ip  }}
                                                        <div style="width: 50px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%;height: 20px" src="data:image/jpeg;base64, {{ re.sloc | changepage }}">
                                                        </div>
                                                    </td>
                                                    {% elif re.sloc == '' or re.sloc == None and re.sip != '' and re.sip != None%}
                                                <td id="image">{{ re.sip | truncate_ip }}
                                                        <div style="width: 30px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%;height: 20px" src="data:image/jpeg;base64, {{ re.sip | truncate_ip | ip2loc | changepage }}">
                                                        </div>
                                                </td>
                                                {% else %}
                                                    <td>None</td>
                                                {% endif %}
                                                    <td>{{ re.sloc }}</td>
                                                    {% if re.origin_url != '' %}
                                                        {% if re.origin_url|length <= 50 %}
                                                            <td>{{ re.origin_url }}</td>
                                                            {% else %}
                                                            <td>{{ re.origin_url | slice:'50'  }}...</td>
                                                            {% endif %}
                                                        {% else %}
                                                        <td>None</td>
                                                        {% endif %}
													<td><span style="color:yellow">已检出</span></td>
                                                {% if re.testdomain.ruletype == 'webshell'  %}
                                                    <td>{{ re.testdomain.name }}<a class="am-badge am-badge-warning am-round">webshell</a> </td>
                                                    {% else %}
                                                    <td>{{ re.testdomain.name }}<a class="am-badge am-badge-danger am-round">domain</a> </td>
                                                    {% endif %}
												</tr>
                                            {% else %}
												<tr class="gradeX" style="width:200px; height:50px;">
													<td>{{ re.created_at }} </td>
                                                    <td>{{ re.host }} </td>
                                                    {% if re.sloc != '' and re.sloc != None %}
                                                    <td id="image">{{ re.sip | truncate_ip  }}
                                                        <div style="width: 50px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%;height: 20px" src="data:image/jpeg;base64, {{ re.sloc | changepage }}">
                                                        </div>
                                                    </td>
                                                    {% elif re.sloc == '' or re.sloc == None and re.sip != '' and re.sip != None%}
                                                <td id="image">{{ re.sip | truncate_ip }}
                                                        <div style="width: 30px;display: inline-block;">
                                                            <img class="imgage" style="width: 100%;height: 20px" src="data:image/jpeg;base64, {{ re.sip | truncate_ip | ip2loc | changepage }}">
                                                        </div>
                                                </td>
                                                {% else %}
                                                    <td>None</td>
                                                {% endif %}
                                                    <td>{{ re.sloc }}</td>
                                                    {% if re.origin_url != '' %}
                                                        {% if re.origin_url|length <= 50 %}
                                                            <td>{{ re.origin_url }}</td>
                                                            {% else %}
                                                            <td>{{ re.origin_url | slice:'50'  }}...</td>
                                                            {% endif %}
                                                        {% else %}
                                                        <td>None</td>
                                                        {% endif %}
													<td><span style="color:greenyellow">未检出</span></td>
                                                    <td></td>
												</tr>
                                            {% endif %}
                                            {% endfor %}
												<!-- more data -->
											</tbody>
										</table>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
            </div>
        {% endblock %}
 {% block js %}
     $(document).ready(function () {
     getdata();
     showchart();
     setInterval(getdata, 10000);
        });
     function  getdata(){
            $.ajax({
                url: '{% url 'getalldata' %}',
                type: 'GET',
                success:function (callback_dict) {
                    var callback = $.parseJSON(callback_dict);
                    $('#messagecontainer').text(callback.wait_chec);
                    $('#messagecontain').text(callback.all_data);
                    $('#messageconta').text(callback.bad_data);
                    $('#messagecon').text(callback.wait_bad_data);
                    }
                })
            };
     function  showchart(){
            $.ajax({
                url: '{% url 'getdata' %}',
                type: 'GET',
                success:function (callback) {
                    var callback_dict = $.parseJSON(callback);
                    show(callback_dict.time, callback_dict.alldata_list);
                    }
                })
            };
    function show(time, alldata) {
    var myChart = echarts.init(document.getElementById('main'));
        option = {
    tooltip : {
        trigger: 'axis'
    },
     legend: {
        data:['检验数量']
    },
    calculable : true,
    xAxis : [
        {
            axisLabel: {show: true,textStyle: {color: '#fff'}},
            type : 'category',
            boundaryGap : false,
            data : time
        }
    ],
    yAxis : [
        {
            axisLabel: {show: true,textStyle: {color: '#fff'}},
            type : 'value'
        }
    ],
    series : [
        {
            name:'当天检验数量',
            type:'line',
            radius : '55%',
            stack: '总量',
            itemStyle : {
                    normal : {lineStyle:{color:'dodgerblue'}, areaStyle: {color:'dodgerblue'}}},
            data:alldata
        }
    ]
};
    myChart.setOption(option);
     window.onresize = myChart.resize;
         };
     {% endblock %}
{% block other %}<script>
            </script>{% endblock %}

var callback = $.parseJSON(callback_dict);